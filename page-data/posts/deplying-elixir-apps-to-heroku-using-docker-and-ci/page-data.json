{"componentChunkName":"component---src-templates-post-js","path":"/posts/deplying-elixir-apps-to-heroku-using-docker-and-ci","result":{"data":{"markdownRemark":{"html":"<p>This post will show in simple steps how you can deliver your Elixir + Phoenix app to Heroku using your own docker imagem, rather than pushing your code using git and waiting for a buildpack to build it for you.</p>\n<p>Also, this post will give youn an example on how to configure Github Actions to test and deploy your code.</p>\n<h2>Creating an Application</h2>\n<p>To create your new app, you must have elixir installed (<a href=\"https://elixir-lang.org/install.html\" target=\"_blank\" rel=\"nofollow\">tutorial</a>) and also the archive for phoenix (<a href=\"https://hexdocs.pm/phoenix/installation.html\" target=\"_blank\" rel=\"nofollow\">tutorial</a>).</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mix phx.new my_app</code></pre></div>\n<p>Now enter your new app folder and install dependencies (if you haven't already did it during creation).</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> my_app\nmix deps.get <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">npm</span> <span class=\"token function\">install</span> --prefix assets</code></pre></div>\n<p>And then publish it to your github account (remember to create a repository <a href=\"https://github.com/new\" target=\"_blank\" rel=\"nofollow\">here</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> init\n<span class=\"token comment\"># remember to replace remote with your repo url</span>\n<span class=\"token function\">git</span> remote <span class=\"token function\">add</span> origin git@github.com:YOUR_USERNAME/my_app.git\n<span class=\"token function\">git</span> <span class=\"token function\">add</span> --all\n<span class=\"token function\">git</span> commit -m <span class=\"token string\">'chore: phoenix init'</span>\n<span class=\"token function\">git</span> push origin master</code></pre></div>\n<h2>Configuring Github Actions</h2>\n<p>To test and deploy your app, I recommend using <a href=\"https://github.com/features/actions\" target=\"_blank\" rel=\"nofollow\">Github Actions</a>. It runs as other continuous integration softwares, but for me it seems to be simpler since it is part of the repository on Github.</p>\n<p>To setup a workflow for testing, create the following file at <code class=\"language-text\">.github/workflows/elixir.yml</code> with the following content:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Elixir\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"**\"</span>\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">container</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> elixir<span class=\"token punctuation\">:</span>1.9.4\n    <span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">postgres</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> postgres\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">POSTGRES_USER</span><span class=\"token punctuation\">:</span> postgres\n          <span class=\"token key atrule\">POSTGRES_DB</span><span class=\"token punctuation\">:</span> my_app_test\n          <span class=\"token key atrule\">POSTGRES_PASSWORD</span><span class=\"token punctuation\">:</span> postgres\n        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> 5432/tcp\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup deps caching\n      <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> deps_cache\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/cache@v1\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> deps\n        <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> runner.os <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>deps<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> hashFiles('<span class=\"token important\">**/mix.lock')</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">restore-keys</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          ${{ runner.os }}-deps-</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup _build caching\n      <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> build_cache\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/cache@v1\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> _build\n        <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> runner.os <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>build<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.sha <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">restore-keys</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          ${{ runner.os }}-build-</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install Dependencies\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        mix local.rebar --force\n        mix local.hex --force\n        mix deps.get\n        mix deps.compile</span>\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">MIX_ENV</span><span class=\"token punctuation\">:</span> test\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Run Dialyzer Analysis\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> mix dialyzer <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>format short\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Check code Format\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> mix format <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>check<span class=\"token punctuation\">-</span>formatted <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>dry<span class=\"token punctuation\">-</span>run\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Run code Analysis\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> mix credo <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>strict\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup Database\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        mix ecto.create\n        mix ecto.migrate</span>\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">MIX_ENV</span><span class=\"token punctuation\">:</span> test\n        <span class=\"token key atrule\">DATABASE_HOSTNAME</span><span class=\"token punctuation\">:</span> postgres\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Run tests with coverage\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> mix test <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>cover <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>raise\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">MIX_ENV</span><span class=\"token punctuation\">:</span> test\n        <span class=\"token key atrule\">DATABASE_HOSTNAME</span><span class=\"token punctuation\">:</span> postgres\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Save coverage report\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/upload<span class=\"token punctuation\">-</span>artifact@v2\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> test_coverage_report\n        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> cover/</code></pre></div>\n<p>Now change your <code class=\"language-text\">mix.exs</code> to include dependencies that are missing for our CI script:</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\"><pre class=\"language-elixir\"><code class=\"language-elixir\"><span class=\"token comment\"># replace elixir's version to which one you're using (currently mine is 1.9.4)</span>\n<span class=\"token comment\"># and also add dialyxir (dialyzer) config</span>\n<span class=\"token keyword\">def</span> project <span class=\"token keyword\">do</span>\n  <span class=\"token punctuation\">[</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token attr-name\">elixir:</span> <span class=\"token string\">\"~> 1.9\"</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token attr-name\">dialyzer:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token attr-name\">plt_add_apps:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token atom symbol\">:ex_unit</span><span class=\"token punctuation\">,</span>\n        <span class=\"token atom symbol\">:mix</span><span class=\"token punctuation\">,</span>\n        <span class=\"token atom symbol\">:erts</span><span class=\"token punctuation\">,</span>\n        <span class=\"token atom symbol\">:phoenix_pubsub</span><span class=\"token punctuation\">,</span>\n        <span class=\"token atom symbol\">:ecto</span><span class=\"token punctuation\">,</span>\n        <span class=\"token atom symbol\">:telemetry</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token attr-name\">list_unused_filters:</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token comment\"># and add the following lines to your deps list</span>\n<span class=\"token keyword\">defp</span> deps <span class=\"token keyword\">do</span>\n <span class=\"token punctuation\">[</span>\n   <span class=\"token operator\">...</span>\n   <span class=\"token punctuation\">{</span><span class=\"token atom symbol\">:credo</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"~> 1.4.0\"</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">only:</span> <span class=\"token punctuation\">[</span><span class=\"token atom symbol\">:dev</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:test</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">runtime:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">{</span><span class=\"token atom symbol\">:dialyxir</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"~> 1.0.0\"</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">runtime:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">allow_pre:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">only:</span> <span class=\"token punctuation\">[</span><span class=\"token atom symbol\">:dev</span><span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:test</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>\n <span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>Now run dependencies download again:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mix deps.get</code></pre></div>\n<p>At last, just make a little changes into your testing config file (<code class=\"language-text\">config/test.exs</code>) to run with CI</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\"><pre class=\"language-elixir\"><code class=\"language-elixir\">config <span class=\"token atom symbol\">:my_app</span><span class=\"token punctuation\">,</span> MyApp<span class=\"token punctuation\">.</span>Repo<span class=\"token punctuation\">,</span>\n  <span class=\"token attr-name\">username:</span> <span class=\"token string\">\"postgres\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token attr-name\">password:</span> <span class=\"token string\">\"postgres\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token attr-name\">database:</span> <span class=\"token string\">\"my_app_test#{System.get_env(\"</span>MIX_TEST_PARTITION<span class=\"token string\">\")}\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\"># just changed hostname to fetch from env vars</span>\n  <span class=\"token attr-name\">hostname:</span> System<span class=\"token punctuation\">.</span>get_env<span class=\"token punctuation\">(</span><span class=\"token string\">\"DATABASE_HOSTNAME\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token attr-name\">pool:</span> Ecto<span class=\"token punctuation\">.</span>Adapters<span class=\"token punctuation\">.</span>SQL<span class=\"token punctuation\">.</span>Sandbox</code></pre></div>\n<p><strong>Important</strong>: Since the first CI run won't have any cache, it will probably take a long time to finish (mainly because of dialyzer), but for next times it will be better.</p>\n<p>Now, before pushing these changes to Github, make sure your code is formatted (<code class=\"language-text\">mix format</code>) and check if are any credo fixes to do (<code class=\"language-text\">mix credo --strict</code>) - and there were some design suggestions to implement.</p>\n<p>Then push everything:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> <span class=\"token function\">add</span> --all\n<span class=\"token function\">git</span> commit -m <span class=\"token string\">'chore: github actions'</span>\n<span class=\"token function\">git</span> push origin master</code></pre></div>\n<p>You can check your action status under \"Actions\" on your Github repository. Also, after finished, there is an \"Artifacts\" section under a run that shows the test coverage report.</p>\n<h2>Configuring the release</h2>\n<p>Now it is time to configure our application to be deployed. It includes setting up the release and the docker file.</p>\n<p>To start, generate release config files:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mix release.init</code></pre></div>\n<p>Now, delete the file <code class=\"language-text\">config/prod.secret.exs</code> and remove its usage from <code class=\"language-text\">config/prod.exs</code> where it is written something like <code class=\"language-text\">import_config &quot;prod.secret.exs&quot;</code>.</p>\n<p>The next step is to create a file named <code class=\"language-text\">config/releases.exs</code>. This file will only be evaluated on release environment and not while you run using mix, for example (and as I know, this kind of configuration will change by elixir 1.11). Inside this file, put the following content:</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\"><pre class=\"language-elixir\"><code class=\"language-elixir\"><span class=\"token keyword\">import</span> Config\n\ndatabase_url <span class=\"token operator\">=</span>\n  System<span class=\"token punctuation\">.</span>get_env<span class=\"token punctuation\">(</span><span class=\"token string\">\"DATABASE_URL\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span>\n    raise <span class=\"token string\">\"\"\"\n    environment variable DATABASE_URL is missing.\n    For example: ecto://USER:PASS@HOST/DATABASE\n    \"\"\"</span>\n\n<span class=\"token comment\"># TODO: replace :my_app and MyApp with your app's config</span>\nconfig <span class=\"token atom symbol\">:my_app</span><span class=\"token punctuation\">,</span> MyApp<span class=\"token punctuation\">.</span>Repo<span class=\"token punctuation\">,</span>\n  <span class=\"token attr-name\">url:</span> database_url<span class=\"token punctuation\">,</span>\n  <span class=\"token attr-name\">pool_size:</span> String<span class=\"token punctuation\">.</span>to_integer<span class=\"token punctuation\">(</span>System<span class=\"token punctuation\">.</span>get_env<span class=\"token punctuation\">(</span><span class=\"token string\">\"POOL_SIZE\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"10\"</span><span class=\"token punctuation\">)</span>\n\nsecret_key_base <span class=\"token operator\">=</span>\n  System<span class=\"token punctuation\">.</span>get_env<span class=\"token punctuation\">(</span><span class=\"token string\">\"SECRET_KEY_BASE\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span>\n    raise <span class=\"token string\">\"\"\"\n    environment variable SECRET_KEY_BASE is missing.\n    You can generate one by calling: mix phx.gen.secret\n    \"\"\"</span>\n\n<span class=\"token comment\"># TODO: replace :my_app and MyAppWeb with your app's config</span>\nconfig <span class=\"token atom symbol\">:my_app</span><span class=\"token punctuation\">,</span> MyAppWeb<span class=\"token punctuation\">.</span>Endpoint<span class=\"token punctuation\">,</span>\n  <span class=\"token attr-name\">url:</span> <span class=\"token punctuation\">[</span><span class=\"token attr-name\">host:</span> System<span class=\"token punctuation\">.</span>get_env<span class=\"token punctuation\">(</span><span class=\"token string\">\"PROJECT_URL\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">port:</span> <span class=\"token number\">80</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token attr-name\">http:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token attr-name\">port:</span> String<span class=\"token punctuation\">.</span>to_integer<span class=\"token punctuation\">(</span>System<span class=\"token punctuation\">.</span>get_env<span class=\"token punctuation\">(</span><span class=\"token string\">\"PORT\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"4000\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token attr-name\">transport_options:</span> <span class=\"token punctuation\">[</span><span class=\"token attr-name\">socket_opts:</span> <span class=\"token punctuation\">[</span><span class=\"token atom symbol\">:inet6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token attr-name\">secret_key_base:</span> secret_key_base<span class=\"token punctuation\">,</span>\n  <span class=\"token attr-name\">server:</span> <span class=\"token boolean\">true</span></code></pre></div>\n<p>Now, create a dockerfile at root (<code class=\"language-text\">Dockerfile</code>) with the following content:</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token keyword\">FROM</span> elixir<span class=\"token punctuation\">:</span>1.9.4<span class=\"token punctuation\">-</span>alpine as build\n\n<span class=\"token keyword\">ARG</span> MIX_ENV=prod\n<span class=\"token keyword\">ENV</span> MIX_ENV=$<span class=\"token punctuation\">{</span>MIX_ENV<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># IMPORTANT: Replace with your own timezone</span>\n<span class=\"token keyword\">RUN</span> apk add <span class=\"token punctuation\">-</span>U <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>no<span class=\"token punctuation\">-</span>cache bash git build<span class=\"token punctuation\">-</span>base gcc make tzdata ca<span class=\"token punctuation\">-</span>certificates nodejs npm \\\n    &amp;&amp; cp /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime \\\n    &amp;&amp; echo <span class=\"token string\">\"America/Sao_Paulo\"</span> <span class=\"token punctuation\">></span> /etc/timezone\n\n<span class=\"token keyword\">ARG</span> HOME=<span class=\"token string\">\"/app\"</span>\n\n<span class=\"token keyword\">RUN</span> mkdir <span class=\"token punctuation\">-</span>p $<span class=\"token punctuation\">{</span>HOME<span class=\"token punctuation\">}</span>/src\n<span class=\"token keyword\">WORKDIR</span> $<span class=\"token punctuation\">{</span>HOME<span class=\"token punctuation\">}</span>/src\n\n<span class=\"token keyword\">COPY</span> mix.exs mix.lock $<span class=\"token punctuation\">{</span>HOME<span class=\"token punctuation\">}</span>/src/\n<span class=\"token keyword\">COPY</span> config/ $<span class=\"token punctuation\">{</span>HOME<span class=\"token punctuation\">}</span>/src/config\n\n<span class=\"token keyword\">RUN</span> mix local.hex <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>force &amp;&amp; mix local.rebar <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>force\n\n<span class=\"token keyword\">RUN</span> mix deps.get &amp;&amp; \\\n    mix deps.compile\n\n<span class=\"token keyword\">COPY</span> assets/ $<span class=\"token punctuation\">{</span>HOME<span class=\"token punctuation\">}</span>/src/assets\n\n<span class=\"token keyword\">RUN</span> cd assets &amp;&amp; \\\n    npm install &amp;&amp; \\\n    npm rebuild node<span class=\"token punctuation\">-</span>sass &amp;&amp; \\\n    cd <span class=\"token punctuation\">-</span>\n\n<span class=\"token keyword\">ENV</span> PATH=./node_modules/.bin<span class=\"token punctuation\">:</span>$PATH\n\n<span class=\"token keyword\">RUN</span> cd assets/ &amp;&amp; \\\n    npm run deploy &amp;&amp; cd <span class=\"token punctuation\">-</span>\n\n<span class=\"token keyword\">COPY</span> lib/ $<span class=\"token punctuation\">{</span>HOME<span class=\"token punctuation\">}</span>/src/lib\n<span class=\"token keyword\">COPY</span> priv/ $<span class=\"token punctuation\">{</span>HOME<span class=\"token punctuation\">}</span>/src/priv\n\n<span class=\"token keyword\">RUN</span> mix compile &amp;&amp; \\\n    mix phx.digest &amp;&amp; \\\n    mix release\n\n<span class=\"token comment\"># ---------------------------------------------------------</span>\n<span class=\"token comment\"># Run Release</span>\n<span class=\"token comment\"># ---------------------------------------------------------</span>\n<span class=\"token keyword\">FROM</span> alpine<span class=\"token punctuation\">:</span>3.11.6\n\n<span class=\"token keyword\">ARG</span> HOME=<span class=\"token string\">\"/app\"</span>\n\n<span class=\"token keyword\">RUN</span> apk add <span class=\"token punctuation\">-</span>U <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>no<span class=\"token punctuation\">-</span>cache bash ncurses<span class=\"token punctuation\">-</span>libs openssl tzdata\n\n<span class=\"token comment\"># IMPORTANT: Replace with your own timezone</span>\n<span class=\"token keyword\">RUN</span> cp /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime &amp;&amp; \\\n    echo <span class=\"token string\">\"America/Sao_Paulo\"</span> <span class=\"token punctuation\">></span> /etc/timezone\n\n<span class=\"token comment\"># TODO: Replace \"my_app\" with your application's name</span>\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>from=build /app/src/_build/prod/rel/my_app /app/.\n\n<span class=\"token keyword\">ENV</span> MIX_ENV=$<span class=\"token punctuation\">{</span>MIX_ENV<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># TODO: Replace \"my_app\" with your application's name</span>\n<span class=\"token keyword\">CMD</span> /app/bin/my_app start</code></pre></div>\n<p>And then commit your changes to github:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> <span class=\"token function\">add</span> --all\n<span class=\"token function\">git</span> commit -m <span class=\"token string\">'chore: release setup'</span>\n<span class=\"token function\">git</span> push origin master</code></pre></div>\n<h2>Creating a Heroku app</h2>\n<p>You now need some configuration on Heroku to have your app correctly configured. It is possible doing only by their website panel, but I will list below all the commands needed to do it by console using <a href=\"https://devcenter.heroku.com/articles/heroku-cli\" target=\"_blank\" rel=\"nofollow\">heroku-cli</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">heroku login\nheroku apps:create <span class=\"token comment\"># will generate a random name if you don't provide one (globally unique)</span>\nheroku config:set <span class=\"token assign-left variable\">POOL_SIZE</span><span class=\"token operator\">=</span><span class=\"token number\">10</span>\nheroku config:set <span class=\"token assign-left variable\">SECRET_KEY_BASE</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>mix phx.gen.secret<span class=\"token variable\">)</span></span>\n<span class=\"token comment\"># the command below gets the hostname from project url</span>\n<span class=\"token comment\"># and the system will use it as base for url generation</span>\nheroku config:set <span class=\"token assign-left variable\">PROJECT_URL</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>heroku info -s <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> web_url <span class=\"token operator\">|</span> <span class=\"token function\">cut</span> -d<span class=\"token operator\">=</span> -f2 <span class=\"token operator\">|</span> <span class=\"token function\">cut</span> -d/ -f3<span class=\"token variable\">)</span></span>\nheroku addons:create heroku-postgresql:hobby-dev</code></pre></div>\n<p>Just an additional comment: we've set some environment variables, but we didn't provide both \"DATABASE_URL\" and \"PORT\" used on our <code class=\"language-text\">releases.exs</code> config. \"DATABASE_URL\" is automatically inserted by the postgresql addon we've added and \"PORT\" is given by Heroku on each run (so if you set one, probably your app won't run).</p>\n<p>You can visit your app by running the command <code class=\"language-text\">heroku open</code> and you will see a default page generated by them.</p>\n<h2>Updating the CI Action</h2>\n<p>All the groundwork is ready to support our deploys (Docker configuration and Heroku setup). The only part needed now is to add one more step into the CI's file.\nOne specification is that we're going to trigger deploys only when there is a push to the <code class=\"language-text\">master</code> branch, and all other branches will only run the test flow.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">...</span> <span class=\"token comment\"># the code you already have</span>\n  <span class=\"token key atrule\">deploy-homolog</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> github.ref == 'refs/heads/master' <span class=\"token comment\"># filters pushes only on master</span>\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> test <span class=\"token comment\"># runs only after tests</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> akhileshns/heroku<span class=\"token punctuation\">-</span>deploy@v3.0.4\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">heroku_email</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.HEROKU_EMAIL <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">heroku_api_key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.HEROKU_API_KEY <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">heroku_app_name</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.HEROKU_APP_NAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">usedocker</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<p>You noticed that there are some <code class=\"language-text\">secrets</code> variables being interpolated into the action. To setup it, go to your Github repository, open \"Settings\" and then \"Secrets\". Create these values:</p>\n<ul>\n<li>HEROKU_EMAIL - the email address related to your Heroku account;</li>\n<li>HEROKU<em>APP</em>NAME - your app's name that is part of your url or you can confirm it by running <code class=\"language-text\">heroku apps:info</code> and see the first line (or just run <code class=\"language-text\">heroku apps:info | grep &#39;===&#39; | cut -d&#39; &#39; -f2</code> that cuts it for you);</li>\n<li>HEROKU<em>API</em>KEY - run <code class=\"language-text\">heroku authorizations:create</code> on your console and get the \"Token:\" value.</li>\n</ul>\n<p>Now you are ready to deploy what is on your <code class=\"language-text\">master</code> branch. Just commit the changes made into CI's file:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> <span class=\"token function\">add</span> --all\n<span class=\"token function\">git</span> commit -m <span class=\"token string\">'refactor: ci deploy'</span>\n<span class=\"token function\">git</span> push origin master</code></pre></div>\n<p>Just wait for CI to complete and visit your website again by running <code class=\"language-text\">heroku open</code>.</p>\n<h2>And what about migrations?</h2>\n<p>Just one piece is missing: since the code is being packaged by <code class=\"language-text\">mix release</code>, you don't have a command to run migrations inside your server. It is needed to create an elixir module that run migrations. And since we're going to create that, why not let migrations to run automatically after a deploy?</p>\n<p>I tried two options for it: the first one is to put a script on the server that runs the migration and then starts the server. And another one that is call the migration remotely from CI. I choose this last one because, since heroku stops your free server after 30mins and starts again when someone opens the url, it would take more time for this startup if migrations were run all the times.</p>\n<p>To start, create this module at your app's folder (mine is \"my<em>app\") `lib/my</em>app/commands/release_tasks.ex`:</p>\n<div class=\"gatsby-highlight\" data-language=\"elixir\"><pre class=\"language-elixir\"><code class=\"language-elixir\"><span class=\"token keyword\">defmodule</span> MyApp<span class=\"token punctuation\">.</span>Command<span class=\"token punctuation\">.</span>ReleaseTasks <span class=\"token keyword\">do</span>\n  <span class=\"token attribute variable\">@moduledoc</span> <span class=\"token boolean\">false</span>\n\n  <span class=\"token keyword\">def</span> migrate <span class=\"token keyword\">do</span>\n    <span class=\"token comment\"># TODO: rename :my_app to your app's name</span>\n    <span class=\"token punctuation\">{</span><span class=\"token atom symbol\">:ok</span><span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> Application<span class=\"token punctuation\">.</span>ensure_all_started<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:my_app</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># TODO: rename :my_app to your app's name</span>\n    path <span class=\"token operator\">=</span> Application<span class=\"token punctuation\">.</span>app_dir<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:my_app</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"priv/repo/migrations\"</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># TODO: rename MyApp to your project's module</span>\n    Ecto<span class=\"token punctuation\">.</span>Migrator<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>MyApp<span class=\"token punctuation\">.</span>Repo<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> <span class=\"token atom symbol\">:up</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">all:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token atom symbol\">:init</span><span class=\"token punctuation\">.</span>stop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>Then create an alias to this module's command as a executable file that will be on the container. Put the following content into a file named <code class=\"language-text\">rel/bin/migrate</code> (no extension):</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">#!/bin/sh\n\n# TODO: replace my_app and MyApp to your app&#39;s name\n/app/bin/my_app eval &#39;MyApp.Command.ReleaseTasks.migrate()&#39;</code></pre></div>\n<p>Now, update your Dockerfile last step (the runner) to copy all files inside <code class=\"language-text\">/rel/bin</code> into container's <code class=\"language-text\">/app/bin/</code> (for example, your app's release entrypoint goes to this folder): </p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token punctuation\">...</span>\n<span class=\"token comment\"># below this line</span>\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>from=build /app/src/_build/prod/rel/my_app /app/.\n<span class=\"token comment\"># insert this</span>\n<span class=\"token keyword\">COPY</span> rel/bin/ /app/bin/</code></pre></div>\n<p>Finally, just update the last step of your workflow (file present at <code class=\"language-text\">.github/workflows/elixir.yml</code>) to run this new command directly on the deployed container using heroku cli:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">deploy-homolog</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">...</span>\n    <span class=\"token comment\"># place it as the last step (after the \"heroku-deploy\" action)</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Run Migrations\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> heroku run bash '/app/bin/migrate' <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>app $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.HEROKU_APP_NAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>type=worker\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">HEROKU_API_KEY</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.HEROKU_API_KEY <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Commit the code and wait your next migrations will automatically run!</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">git</span> <span class=\"token function\">add</span> --all\n<span class=\"token function\">git</span> commit -m <span class=\"token string\">'chore: run migrations'</span>\n<span class=\"token function\">git</span> push origin master</code></pre></div>\n<h2>Further improvements</h2>\n<p>You can check the full code hosted at this repository: <a href=\"https://github.com/duzzifelipe/my_elixir_and_heroku_app_example\" target=\"_blank\" rel=\"nofollow\">https://github.com/duzzifelipe/my<em>elixir</em>and<em>heroku</em>app_example</a>.</p>\n<p>There are some specifications that I didn't conver on this post and maybe they will a great point for improvement:</p>\n<ul>\n<li>first of all, there is only one deploy target (that I named homolog). But it could have another step to deploy to production when a release is created, for example;</li>\n<li>I have explained why I prefered to run migrations from CI rather than on container startup, but it could be a problem for production apps, since the new container will replace the old one before the migration runs (and the app will be crashed until it). I found that heroku offers a similar feature to blue-green deployments (<a href=\"https://devcenter.heroku.com/articles/preboot\" target=\"_blank\" rel=\"nofollow\">https://devcenter.heroku.com/articles/preboot</a>) and this could be applied on this project.</li>\n</ul>\n<p>Thats it!</p>","frontmatter":{"date":"06/09/2020","slug":"deplying-elixir-apps-to-heroku-using-docker-and-ci","title":"Deploying Elixir apps to heroku using docker and CI"}}},"pageContext":{"slug":"deplying-elixir-apps-to-heroku-using-docker-and-ci"}}}